<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Magic Gift V15.0 (Audio Fix)</title>
    
    <style>
        body { margin: 0; overflow: hidden; background: radial-gradient(circle at center, #001020 0%, #000000 100%); touch-action: none; font-family: 'Courier New', sans-serif; -webkit-user-select: none; user-select: none; }
        #canvas-container { position: absolute; inset: 0; z-index: 1; }
        #ui-layer { position: absolute; inset: 0; z-index: 10; pointer-events: none; }
        
        /* ÂêØÂä®ÈÅÆÁΩ© */
        #start-overlay {
            position: fixed; inset: 0; background: rgba(0,5,10,0.98); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .start-btn {
            padding: 15px 40px; font-size: 18px; color: #fff; background: transparent;
            border: 2px solid #00bfff; border-radius: 50px; 
            box-shadow: 0 0 20px #00bfff; animation: pulse 2s infinite; cursor: pointer;
        }
        @keyframes pulse { 50% { box-shadow: 0 0 40px #00bfff; } }

        /* UI ÂÖÉÁ¥† */
        h1 { position: absolute; top: 8%; width: 100%; text-align: center; color: #e0f7fa; font-size: 28px; text-shadow: 0 0 10px #00bfff; opacity: 0.9; margin: 0; }
        .left-panel { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; pointer-events: auto; }
        .deco-btn { width: 44px; height: 44px; border-radius: 50%; background: rgba(0, 20, 40, 0.6); border: 1px solid rgba(135, 206, 250, 0.4); color: #fff; font-size: 22px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .bottom-panel { position: absolute; bottom: max(30px, env(safe-area-inset-bottom)); width: 100%; text-align: center; pointer-events: auto; display: flex; flex-direction: column; gap: 12px; align-items: center;}
        .btn-photo { background: rgba(0, 80, 200, 0.4); border: 1px solid #87cefa; color: #e0ffff; padding: 10px 30px; border-radius: 30px; font-weight: bold; display: inline-block; }
        .instruction { font-size: 12px; color: #aaddee; background: rgba(0,0,0,0.6); padding: 6px 16px; border-radius: 15px; }
        #file-input { display: none; }
        #flash-fx { position: fixed; inset:0; background: #fff; opacity:0; pointer-events:none; z-index:20; transition: opacity 0.2s; }
        .top-right { position: absolute; top: 20px; right: 20px; pointer-events: auto; }
        .back-link { color: #87cefa; text-decoration: none; font-size: 12px; border: 1px solid #87cefa; padding: 5px 10px; background: rgba(0,0,0,0.5); }
    </style>

    <script type="importmap">
    { "imports": { "three": "https://registry.npmmirror.com/three/0.160.0/files/build/three.module.js", "three/addons/": "https://registry.npmmirror.com/three/0.160.0/files/examples/jsm/" } }
    </script>
</head>
<body>

    <div id="canvas-container"></div>
    <div id="flash-fx"></div>

    <div id="start-overlay">
        <h2 style="color:#e0ffff; margin-bottom:30px; font-family:serif; letter-spacing:2px;">THE FROZEN GIFT</h2>
        <button class="start-btn" id="btn-start">‚ùÑÔ∏è ÁÇπÂáªÂºÄÂêØÂ£∞Èü≥ ‚ùÑÔ∏è</button>
        <p style="color:#557799; font-size:12px; margin-top:20px;">Sound & Gyroscope Required</p>
    </div>

    <div id="ui-layer">
        <h1>Merry Christmas</h1>
        <div class="top-right"><a href="mission.html" class="back-link">EXIT</a></div>
        
        <div class="left-panel">
            <div class="deco-btn" onclick="addDeco('STAR'); playSound('ding')">‚òÖ</div>
            <div class="deco-btn" onclick="addDeco('GIFT'); playSound('pop')">üéÅ</div>
            <div class="deco-btn" onclick="addDeco('SOCK'); playSound('pop')">üß¶</div>
            <div class="deco-btn" onclick="addDeco('BELL'); playSound('bell')">üîî</div>
        </div>
        
        <div class="bottom-panel">
            <label class="btn-photo">üì∑ ‰∏ä‰º†ÁÖßÁâá<input type="file" id="file-input" multiple accept="image/*"></label>
            <div class="instruction" id="status-text">üëâÂè≥Êªë:ËÄÅ‰∫∫ | üëàÂ∑¶Êªë:È∫ãÈπø | ‚úäÊëá‰∏ÄÊëá:Êö¥È£éÈõ™</div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        const STATE = { mode: 'TREE', gyro: { x: 0, y: 0 }, autoRotate: true, blizzardIntensity: 0 };
        const CONFIG = { tree: { count: 1600, height: 26, radius: 9 } };
        let scene, camera, renderer, composer, mainGroup, treeGroup, photoGroup, snowSystem;
        let particles = [], flyingObjects = [], clock = new THREE.Clock(), textures = {}; 
        let audioCtx = null;

        // --- Èü≥È¢ëÂ¢ûÂº∫Áâà ---
        function initAudio() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // ÂÖ≥ÈîÆÔºöÂº∫Âà∂ÊÅ¢Â§ç AudioContext (iOS ‰øÆÂ§ç)
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }

                // Êí≠ÊîæÊó†Â£∞ÁºìÂÜ≤ÔºåÊâìÈÄöÈÄöÈÅì
                const buffer = audioCtx.createBuffer(1, 1, 22050);
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start(0);
                console.log("Audio System Init: OK");
            } catch(e) { console.error("Audio Init Failed", e); }
        }

        function playSound(type) {
            if(!audioCtx) return;
            if(audioCtx.state === 'suspended') audioCtx.resume(); // ÂèåÈáç‰øùÈô©

            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);

            if (type === 'ding') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.6);
                gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
                osc.start(now); osc.stop(now + 0.6);
            } else if (type === 'bell') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(2000, now);
                gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 1.2);
                osc.start(now); osc.stop(now + 1.2);
            } else if (type === 'pop') {
                osc.type = 'square'; osc.frequency.setValueAtTime(400, now);
                gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            } else if (type === 'whoosh') {
                // ÁÆÄÂçïÁöÑÈ£éÂ£∞
                const duration = 2.0;
                const bufferSize = audioCtx.sampleRate * duration;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * 0.5; // ÁôΩÂô™Èü≥
                
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                const noiseGain = audioCtx.createGain();
                noise.connect(noiseGain); noiseGain.connect(audioCtx.destination);
                
                // È£éÂ£∞ÂåÖÁªúÔºöÊ∑°ÂÖ•Ê∑°Âá∫
                noiseGain.gain.setValueAtTime(0, now);
                noiseGain.gain.linearRampToValueAtTime(0.4, now + 0.5); // Ê∏êÂº∫
                noiseGain.gain.linearRampToValueAtTime(0, now + 2.0); // Ê∏êÂº±
                noise.start(now);
            }
        }

        // --- ËµÑÊ∫ê ---
        function createResources() {
            const c=document.createElement('canvas'); c.width=32; c.height=32;
            const ctx=c.getContext('2d');
            const g=ctx.createRadialGradient(16,16,0,16,16,16); g.addColorStop(0,'rgba(255,255,255,1)'); g.addColorStop(0.4,'rgba(100,200,255,0.4)'); g.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle=g; ctx.fillRect(0,0,32,32); textures.glow = new THREE.CanvasTexture(c);

            textures.getEmoji=(e,s=64)=>{
                const ec=document.createElement('canvas'); ec.width=s; ec.height=s;
                const et=ec.getContext('2d'); et.font=`${s*0.75}px serif`; et.textAlign='center'; et.textBaseline='middle'; et.fillText(e,s/2,s/2+2);
                return new THREE.CanvasTexture(ec);
            }
            textures.snow=textures.getEmoji('‚ùÑÔ∏è'); textures.bell=textures.getEmoji('üîî'); 
            textures.santa=textures.getEmoji('üéÖ',128); textures.deer=textures.getEmoji('ü¶å',128);
        }

        // --- ÂàùÂßãÂåñ ---
        function init() {
            createResources();
            scene=new THREE.Scene(); scene.fog=new THREE.FogExp2(0x000510,0.02);
            camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,1000); camera.position.set(0,5,45);
            renderer=new THREE.WebGLRenderer({antialias:false,alpha:true});
            renderer.setSize(window.innerWidth,window.innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
            renderer.toneMapping=THREE.ReinhardToneMapping;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            const rp=new RenderPass(scene,camera);
            const bp=new UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),1.5,0.4,0.85);
            bp.threshold=0.1; bp.strength=1.8; bp.radius=0.5;
            composer=new EffectComposer(renderer); composer.addPass(rp); composer.addPass(bp);

            scene.add(new THREE.AmbientLight(0x404040,2));
            const l=new THREE.PointLight(0x00bfff,3,100); l.position.set(0,10,20); scene.add(l);

            mainGroup=new THREE.Group(); scene.add(mainGroup);
            treeGroup=new THREE.Group(); mainGroup.add(treeGroup);
            photoGroup=new THREE.Group(); mainGroup.add(photoGroup);

            buildTree(); buildSnow(); createDefaultPhoto(); setupEvents(); animate();
            window.addDeco=addDeco; window.playSound=playSound;
        }

        // --- ÈÄªËæë ---
        function buildTree() {
            const geo=new THREE.TetrahedronGeometry(0.3,0);
            const matM=new THREE.MeshStandardMaterial({color:0x87cefa,roughness:0.1,metalness:0.8,emissive:0x002244});
            const matS=new THREE.SpriteMaterial({map:textures.glow,color:0xffffff,transparent:true,blending:THREE.AdditiveBlending});
            for(let i=0; i<CONFIG.tree.count; i++) {
                const isSprite=Math.random()>0.7;
                const t=Math.random(); const h=CONFIG.tree.height; const r=CONFIG.tree.radius*(1-t);
                const y=t*h-h/2+2; const a=Math.random()*Math.PI*2;
                const pos=new THREE.Vector3(Math.cos(a)*r,y,Math.sin(a)*r);
                let item;
                if(isSprite){ item=new THREE.Sprite(matS.clone()); item.scale.setScalar(0.5+Math.random()); }
                else{ item=new THREE.Mesh(geo,matM.clone()); item.scale.setScalar(0.4+Math.random()*0.6); item.rotation.set(Math.random()*6,Math.random()*6,0); }
                item.position.copy(pos); treeGroup.add(item);
                const len=15+Math.random()*30; const phi=Math.acos(-1+(2*i)/CONFIG.tree.count); const theta=Math.sqrt(CONFIG.tree.count*Math.PI)*phi;
                particles.push({mesh:item, basePos:pos.clone(), scatterPos:new THREE.Vector3(len*Math.cos(theta)*Math.sin(phi), len*Math.sin(theta)*Math.sin(phi), len*Math.cos(phi)), isDeco:false});
            }
        }

        function addDeco(type) {
            let map, s=2.5, c=0xffffff;
            if(type==='BELL'){map=textures.bell;s=3.0;} else if(type==='GIFT')map=textures.getEmoji('üéÅ');
            else if(type==='SOCK')map=textures.getEmoji('üß¶'); else map=null; 
            let item;
            if(type==='STAR'){
                item=new THREE.Mesh(new THREE.OctahedronGeometry(1.5),new THREE.MeshStandardMaterial({color:0xffaa00,emissive:0xff8800,emissiveIntensity:2}));
                item.position.set(0,CONFIG.tree.height/2+3,0);
            } else {
                item=new THREE.Sprite(new THREE.SpriteMaterial({map:map,color:c})); item.scale.setScalar(s);
                const t=Math.random(); const r=CONFIG.tree.radius*(1-t)+1.2; const y=t*CONFIG.tree.height-CONFIG.tree.height/2+2; const a=Math.random()*Math.PI*2;
                item.position.set(Math.cos(a)*r,y,Math.sin(a)*r);
            }
            treeGroup.add(item);
            particles.push({mesh:item, basePos:item.position.clone(), scatterPos:item.position.clone().multiplyScalar(3), isDeco:true});
        }

        function spawnFlyingUnit(type) {
            playSound('whoosh');
            const isSanta=type==='SANTA'; const tex=isSanta?textures.santa:textures.deer; const dir=isSanta?1:-1;
            const s=new THREE.Sprite(new THREE.SpriteMaterial({map:tex,color:0xffffff})); s.scale.setScalar(6);
            s.position.set(-40*dir, 5+Math.random()*10, 15); scene.add(s);
            flyingObjects.push({mesh:s, dir:dir, speed:25+Math.random()*5});
            const st=document.getElementById('status-text'); st.innerText=isSanta?"üéÖ Âú£ËØûËÄÅ‰∫∫Êù•Âï¶ÔºÅ":"ü¶å È∫ãÈπøÈ£ûËøáÔºÅ";
            setTimeout(()=>st.innerText="üëâÂè≥Êªë:ËÄÅ‰∫∫ | üëàÂ∑¶Êªë:È∫ãÈπø | ‚úäÊëá‰∏ÄÊëá:Êö¥È£éÈõ™",2500);
        }

        function setupEvents() {
            window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); composer.setSize(window.innerWidth,window.innerHeight);});
            
            // ÂêØÂä®ÊåâÈíÆÔºöÂêåÊó∂ÂàùÂßãÂåñÈü≥È¢ëÂíå‰º†ÊÑüÂô®
            document.getElementById('btn-start').onclick=async()=>{
                initAudio(); // ÊøÄÊ¥ªÈü≥È¢ë
                document.getElementById('start-overlay').style.opacity=0;
                setTimeout(()=>document.getElementById('start-overlay').remove(),500);
                if(typeof DeviceOrientationEvent?.requestPermission==='function'){ try{await DeviceOrientationEvent.requestPermission();}catch(e){} }
                window.addEventListener('deviceorientation',e=>{STATE.gyro.x=(e.gamma||0)*0.01; STATE.gyro.y=((e.beta||0)-45)*0.01;});
                window.addEventListener('devicemotion',handleShake);
            };

            let sx=0, sy=0, isPinch=false, sp=0;
            document.addEventListener('touchstart',e=>{
                if(e.touches.length===1){sx=e.touches[0].clientX;sy=e.touches[0].clientY;isPinch=false;}
                else if(e.touches.length===2){isPinch=true;sp=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY);}
            },{passive:false});

            document.addEventListener('touchmove',e=>{
                if(e.touches.length===2){
                    e.preventDefault();
                    const d=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY);
                    if(d>sp+40){STATE.mode='SCATTER';STATE.autoRotate=false;document.getElementById('status-text').innerText="‚ú® ËÆ∞ÂøÜÈáçÁé∞ ‚ú®";playSound('pop');}
                    if(d<sp-40){STATE.mode='TREE';STATE.autoRotate=true;}
                }
            },{passive:false});

            document.addEventListener('touchend',e=>{
                if(!isPinch && e.changedTouches.length===1){
                    const ex=e.changedTouches[0].clientX;
                    if(ex-sx>60)spawnFlyingUnit('SANTA'); else if(ex-sx<-60)spawnFlyingUnit('DEER');
                }
            });

            document.getElementById('file-input').addEventListener('change',e=>{
                if(e.target.files[0]){
                    const r=new FileReader();
                    r.onload=v=>{
                        const i=new Image(); i.src=v.target.result;
                        i.onload=()=>{
                            const t=new THREE.TextureLoader().load(v.target.result); t.colorSpace=THREE.SRGBColorSpace;
                            updatePhoto(t, i.width/i.height);
                            document.getElementById('status-text').innerText="‚ú® ËÆ∞ÂøÜÂ∑≤Â∞ÅÂ≠òÔºåÂèåÊåáÂº†ÂºÄÊü•Áúã ‚ú®";
                            playSound('ding');
                        }
                    }; r.readAsDataURL(e.target.files[0]);
                }
            });
        }

        let lastShake=0;
        function handleShake(e){
            const acc=e.accelerationIncludingGravity; if(!acc)return;
            if(Math.abs(acc.x)+Math.abs(acc.y)+Math.abs(acc.z)>30 && Date.now()-lastShake>1500){
                lastShake=Date.now();
                triggerBlizzard();
            }
        }

        function triggerBlizzard() {
            STATE.blizzardIntensity=1.0; 
            playSound('whoosh'); // Êí≠ÊîæÊö¥È£éÈõ™Èü≥Êïà
            const f=document.getElementById('flash-fx'); f.style.opacity=0.8; setTimeout(()=>f.style.opacity=0,300);
            document.getElementById('status-text').innerText="‚ö†Ô∏è Êö¥È£éÈõ™Ë≠¶Êä• ‚ö†Ô∏è";
            if(navigator.vibrate)navigator.vibrate([100,50,100]);
        }

        function buildSnow() {
            const geo=new THREE.BufferGeometry(); const pos=[],vels=[];
            for(let i=0;i<3000;i++){
                pos.push((Math.random()-0.5)*100, (Math.random()-0.5)*100, (Math.random()-0.5)*100);
                vels.push((Math.random()-0.5), -(Math.random()*0.5+0.5), (Math.random()-0.5));
            }
            geo.setAttribute('position',new THREE.Float32BufferAttribute(pos,3));
            geo.setAttribute('velocity',new THREE.Float32BufferAttribute(vels,3));
            snowSystem=new THREE.Points(geo,new THREE.PointsMaterial({map:textures.snow,color:0xffffff,size:1.2,transparent:true,opacity:0.6,depthWrite:false,blending:THREE.AdditiveBlending}));
            scene.add(snowSystem);
        }

        function createDefaultPhoto() {
            const c=document.createElement('canvas'); c.width=512; c.height=512;
            const x=c.getContext('2d'); x.fillStyle='#000'; x.fillRect(0,0,512,512); x.strokeStyle='#00bfff'; x.lineWidth=10; x.strokeRect(10,10,492,492);
            x.font='60px Arial'; x.fillStyle='#fff'; x.textAlign='center'; x.fillText("Merry Christmas",256,256);
            updatePhoto(new THREE.CanvasTexture(c),1);
        }

        function updatePhoto(tex, aspect) {
            if(photoGroup.children[0]) photoGroup.remove(photoGroup.children[0]);
            const w=14*aspect;
            const m=new THREE.Mesh(new THREE.PlaneGeometry(w,14),new THREE.MeshBasicMaterial({map:tex,side:THREE.DoubleSide,transparent:true,opacity:0}));
            photoGroup.add(m);
        }

        function animate() {
            requestAnimationFrame(animate); const dt=clock.getDelta();
            
            const isScatter=STATE.mode==='SCATTER';
            particles.forEach(p=>{
                p.mesh.position.lerp(isScatter?p.scatterPos:p.basePos,4*dt);
                if(!isScatter && !p.isDeco){p.mesh.rotation.x+=dt;p.mesh.rotation.y+=dt;}
            });

            if(STATE.autoRotate) mainGroup.rotation.y+=0.3*dt;
            mainGroup.rotation.z=THREE.MathUtils.lerp(mainGroup.rotation.z,STATE.gyro.x,0.1);
            mainGroup.rotation.x=THREE.MathUtils.lerp(mainGroup.rotation.x,STATE.gyro.y,0.1);

            if(photoGroup.children[0]){
                const m=photoGroup.children[0].material;
                m.opacity=THREE.MathUtils.lerp(m.opacity,isScatter?1:0,5*dt);
                photoGroup.lookAt(camera.position);
            }

            if(snowSystem){
                const pos=snowSystem.geometry.attributes.position.array;
                const vels=snowSystem.geometry.attributes.velocity.array;
                STATE.blizzardIntensity=THREE.MathUtils.lerp(STATE.blizzardIntensity,0,0.5*dt);
                const spd=1+STATE.blizzardIntensity*20; const wind=STATE.blizzardIntensity*20;
                for(let i=0;i<3000;i++){
                    pos[i*3]+=(vels[i*3]+wind)*spd*dt;
                    pos[i*3+1]+=vels[i*3+1]*spd*dt;
                    pos[i*3+2]+=vels[i*3+2]*spd*dt;
                    if(pos[i*3+1]<-50)pos[i*3+1]=50; if(pos[i*3]>50)pos[i*3]=-50; if(pos[i*3]<-50)pos[i*3]=50;
                }
                snowSystem.geometry.attributes.position.needsUpdate=true;
                snowSystem.material.size=1.2+STATE.blizzardIntensity*2;
            }

            for(let i=flyingObjects.length-1;i>=0;i--){
                const o=flyingObjects[i];
                o.mesh.position.x+=o.speed*o.dir*dt;
                o.mesh.position.y+=Math.sin(clock.elapsedTime*10)*0.2;
                if(Math.abs(o.mesh.position.x)>60){scene.remove(o.mesh);flyingObjects.splice(i,1);}
            }
            composer.render();
        }
        init();
    </script>
</body>
</html>
