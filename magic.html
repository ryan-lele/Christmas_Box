<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Gift V7.0 (CDN)</title>
    
    <style>
        @font-face { font-family: 'TechMono'; src: local('Courier New'), monospace; }
        body { margin: 0; background: #000; overflow: hidden; font-family: 'TechMono'; color: #00ffea; }
        
        #hologram-canvas { position: absolute; inset: 0; z-index: 1; }
        
        /* å¼ºåˆ¶è§†é¢‘è§£ç  hack (iOS å¿…é¡») */
        #webcam { position: fixed; top: -2000px; left: -2000px; width: 320px; height: 240px; opacity: 0.01; pointer-events: none; }

        /* --- åŠ è½½ç•Œé¢ --- */
        #loading-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .loader-ring {
            width: 60px; height: 60px; border: 4px solid #333; border-top: 4px solid #00ffea;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        .loading-text { color: #00ffea; font-size: 12px; letter-spacing: 2px; }
        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

        /* UI */
        .hud-layer { position: absolute; width: 100%; pointer-events: none; padding: 15px; box-sizing: border-box; }
        .hud-top { top: 0; display: flex; justify-content: space-between; z-index: 20; }
        .back-btn { pointer-events: auto; color: #00ffea; border: 1px solid #00ffea; padding: 5px 12px; text-decoration: none; font-size: 12px; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        
        #gesture-status { 
            position: absolute; bottom: 80px; left: 0; width: 100%; text-align: center; 
            font-size: 12px; color: #fff; text-shadow: 0 0 5px cyan; opacity: 0.8; z-index: 10;
        }
        
        /* è£…é¥°å */
        .left-dock { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 10px; pointer-events: auto; z-index: 30; }
        .deco-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid rgba(0,255,234,0.3); background: rgba(0,0,0,0.5); color: #00ffea; font-size: 18px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        
        /* æ‹ç…§ä¸Šä¼  */
        .bottom-dock { position: absolute; bottom: 20px; width: 100%; text-align: center; pointer-events: auto; z-index: 30; }
        .upload-btn { border: 1px solid #00ffea; padding: 10px 30px; color: #00ffea; background: rgba(0,50,50,0.5); font-size: 12px; border-radius: 20px; display: inline-block;}
        #file-input { display: none; }
        
        #webcam-preview { position: absolute; top: 10px; right: 10px; width: 80px; height: 60px; border: 1px solid #333; opacity: 0; z-index: 5; transform: scaleX(-1); transition: opacity 0.5s; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
            "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8/+esm"
        }
    }
    </script>
</head>
<body>

    <div id="loading-screen">
        <div class="loader-ring"></div>
        <div class="loading-text" id="loading-msg">CONNECTING...</div>
    </div>

    <div class="hud-layer hud-top">
        <div style="font-size:12px;">â— LIVE</div>
        <a href="mission.html" class="back-btn">EXIT</a>
    </div>

    <canvas id="hologram-canvas"></canvas>
    
    <div class="left-dock">
        <div class="deco-btn" onclick="addDeco('STAR')">â˜…</div>
        <div class="deco-btn" onclick="addDeco('GIFT')">ğŸ</div>
        <div class="deco-btn" onclick="addDeco('SOCK')">ğŸ§¦</div>
    </div>

    <div id="gesture-status">INITIALIZING...</div>
    <canvas id="webcam-preview"></canvas>
    <video id="webcam" autoplay playsinline muted></video>

    <div class="bottom-dock">
        <label class="upload-btn">ğŸ“· UPLOAD PHOTO<input type="file" id="file-input" multiple accept="image/*"></label>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        // çŠ¶æ€
        let handLandmarker = undefined;
        let video = document.getElementById('webcam');
        let aiReady = false;
        
        // --- 1. æé€Ÿå¯åŠ¨ (å¹¶è¡Œ) ---
        async function launch() {
            try {
                // ç«‹å³å¯åŠ¨3DèƒŒæ™¯ï¼Œä¸è¦ç­‰AI
                initThree(); 
                
                document.getElementById('loading-msg').innerText = "REQUESTING CAMERA...";
                const cameraPromise = startCamera(); // è¯·æ±‚æ‘„åƒå¤´
                
                document.getElementById('loading-msg').innerText = "DOWNLOADING AI (1MB)...";
                const aiPromise = loadAI(); // ä¸‹è½½AI (CDN)

                // åªè¦æ‘„åƒå¤´å¥½äº†ï¼Œå°±å…ˆè®©ç”¨æˆ·ç©
                await cameraPromise;
                
                // éšè—åŠ è½½å±‚
                const loader = document.getElementById('loading-screen');
                loader.style.opacity = 0;
                setTimeout(()=>loader.remove(), 500);
                
                startLoop();

                // AI åå°åŠ è½½å®Œæ¯•
                aiPromise.then(() => {
                    aiReady = true;
                    document.getElementById('gesture-status').innerText = "HAND TRACKING ACTIVE";
                });

            } catch (e) {
                console.error(e);
                document.getElementById('loading-msg').innerText = "ERROR: " + e.message;
            }
        }

        // --- 2. æ‘„åƒå¤´ (iOS å…¼å®¹) ---
        async function startCamera() {
            if (!navigator.mediaDevices?.getUserMedia) return false;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user", width: {ideal: 320}, height: {ideal: 240} }
                });
                video.srcObject = stream;
                return new Promise(r => {
                    video.onloadedmetadata = () => { video.play(); r(true); };
                });
            } catch(e) {
                console.warn("Camera denied");
                document.getElementById('gesture-status').innerText = "CAMERA DENIED - AUTO MODE";
                return false;
            }
        }

        // --- 3. AI åŠ è½½ (çº¯ CDN æ–¹æ¡ˆ) ---
        async function loadAI() {
            // å¼•æ“
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8/wasm"
            );
            // æ¨¡å‹ï¼šç›´æ¥ä½¿ç”¨ Google å®˜æ–¹å­˜å‚¨æ¡¶çš„ Lite æ¨¡å‹ (CDN)
            // è¿™æ ·å°±ä¸éœ€è¦ä»ä½ çš„ Netlify ä¸‹è½½äº†ï¼Œé€Ÿåº¦æå¿«
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 1
            });
        }

        // --- 4. 3D æ¸²æŸ“ (ç²¾ç®€ç¨³å®šç‰ˆ) ---
        let scene, camera, renderer, composer, group;
        const particles = [];
        
        function initThree() {
            scene = new THREE.Scene(); 
            camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 6, 45);
            renderer = new THREE.WebGLRenderer({canvas: document.getElementById('hologram-canvas'), alpha:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            const rp = new RenderPass(scene, camera);
            const bp = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.6, 0.85);
            composer = new EffectComposer(renderer); composer.addPass(rp); composer.addPass(bp);

            group = new THREE.Group(); scene.add(group);
            
            // é€ æ ‘
            const geo = new THREE.TetrahedronGeometry(0.5);
            const mat = new THREE.MeshBasicMaterial({color: 0x00ffea, transparent:true, opacity:0.8});
            
            for(let i=0; i<900; i++) {
                const mesh = new THREE.Mesh(geo, mat);
                const t = Math.random(); const y = t*30 - 15; const r = (1-t)*10; const a = Math.random()*6.28;
                mesh.position.set(Math.cos(a)*r, y, Math.sin(a)*r);
                mesh.userData = { 
                    basePos: mesh.position.clone(),
                    scatterPos: new THREE.Vector3((Math.random()-0.5)*60, (Math.random()-0.5)*60, (Math.random()-0.5)*60),
                };
                group.add(mesh); particles.push(mesh);
            }
            
            // ç¯å…‰
            const light = new THREE.PointLight(0x00ffff, 1, 100); light.position.set(10, 10, 10); scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        }

        window.addDeco = (type) => {
            const colors = {STAR:0xffff00, GIFT:0xff0000, SOCK:0x00ff00, APPLE:0xff0000, BAUBLE:0x0000ff};
            const m = new THREE.Mesh(new THREE.SphereGeometry(1), new THREE.MeshBasicMaterial({color: colors[type] || 0xffffff}));
            m.position.set((Math.random()-0.5)*15, Math.random()*20-5, 8);
            group.add(m);
        }

        // å¾ªç¯
        const webcamCtx = document.getElementById('webcam-preview').getContext('2d');
        document.getElementById('webcam-preview').width = 160;
        document.getElementById('webcam-preview').height = 120;

        function startLoop() {
            function render() {
                let handDetected = false;
                
                // åªæœ‰å½“ AI ä¸‹è½½å®Œæ¯• (aiReady=true) ä¸”è§†é¢‘åœ¨æ’­æ”¾æ—¶æ‰æ£€æµ‹
                if (aiReady && video.readyState >= 2) {
                    let results;
                    try { results = handLandmarker.detectForVideo(video, performance.now()); } catch(e){}
                    
                    webcamCtx.drawImage(video, 0, 0, 160, 120); // è°ƒè¯•ç”»é¢
                    
                    if(results && results.landmarks.length > 0) {
                        handDetected = true;
                        const lm = results.landmarks[0];
                        const wrist = lm[0]; const tip = lm[12]; 
                        const dist = Math.hypot(tip.x-wrist.x, tip.y-wrist.y);
                        
                        document.getElementById('gesture-status').innerText = dist > 0.3 ? "âœ‹ OPEN: SCATTER" : "âœŠ FIST: SPIN";
                        
                        if (dist > 0.3) {
                            particles.forEach(p => p.position.lerp(p.userData.scatterPos, 0.08));
                        } else {
                            particles.forEach(p => p.position.lerp(p.userData.basePos, 0.1));
                            group.rotation.y += 0.1;
                        }
                    }
                }

                if (!handDetected) {
                    group.rotation.y += 0.005; // è‡ªåŠ¨æ…¢æ—‹è½¬
                    particles.forEach(p => p.position.lerp(p.userData.basePos, 0.05));
                }
                
                composer.render();
                requestAnimationFrame(render);
            }
            render();
        }
        
        // è°ƒè¯•å¼€å…³
        document.addEventListener('click', (e) => {
            if(e.clientY < 50 && e.clientX > window.innerWidth - 50) {
                document.getElementById('webcam-preview').style.opacity = 
                    document.getElementById('webcam-preview').style.opacity == 1 ? 0 : 1;
            }
        });

        // å›¾ç‰‡ä¸Šä¼ 
        const fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const tex = new THREE.TextureLoader().load(ev.target.result);
                    const photo = new THREE.Mesh(new THREE.PlaneGeometry(5,5*0.75), new THREE.MeshBasicMaterial({map:tex, side:THREE.DoubleSide}));
                    photo.position.z = 10;
                    group.add(photo);
                    alert("Photo Added! Use hand to rotate.");
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        launch();
    </script>
</body>
</html>
