<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hologram Debug Mode</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; color: cyan; font-family: monospace; }
        #hologram-canvas { position: absolute; top: 0; left: 0; z-index: 1; width: 100%; height: 100%; }
        /* 调试控制台 */
        #debug-console {
            position: absolute; top: 0; left: 0; width: 100%; height: 200px;
            background: rgba(0,0,0,0.8); z-index: 9999; color: #ff3333;
            font-size: 10px; overflow-y: scroll; pointer-events: none;
            padding: 10px; border-bottom: 1px solid red;
        }
        .log-info { color: #00ff00; }
        .log-error { color: #ff0000; font-weight: bold; }
        
        #webcam-wrapper { position: absolute; bottom: 10px; right: 10px; width: 100px; height: 75px; border: 1px solid cyan; z-index: 10; transform: scaleX(-1); }
        video { width: 100%; height: 100%; object-fit: cover; }
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://registry.npmmirror.com/three/0.160.0/files/build/three.module.js",
            "three/addons/": "https://registry.npmmirror.com/three/0.160.0/files/examples/jsm/",
            "@mediapipe/tasks-vision": "./js/vision_bundle.js"
        }
    }
    </script>
</head>
<body>
    <div id="debug-console">=== SYSTEM START ===<br></div>

    <canvas id="hologram-canvas"></canvas>
    <div id="webcam-wrapper"><video id="webcam" autoplay playsinline></video></div>

    <script>
        // --- 1. 劫持控制台输出到屏幕 ---
        const consoleDiv = document.getElementById('debug-console');
        function log(msg, type='info') {
            const line = document.createElement('div');
            line.className = type === 'error' ? 'log-error' : 'log-info';
            line.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        window.onerror = function(msg, url, line) { log(`ERROR: ${msg} (Line ${line})`, 'error'); };
        console.log = function(m) { log(m); };
        console.error = function(m) { log(m, 'error'); };
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        log("Module loaded successfully.");

        async function init() {
            try {
                // 1. 初始化 Three.js
                log("Init Three.js...");
                const canvas = document.getElementById('hologram-canvas');
                const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 100);
                camera.position.set(0, 0, 20);
                
                // 加个旋转立方体证明渲染器活着
                const geo = new THREE.BoxGeometry(2,2,2);
                const mat = new THREE.MeshBasicMaterial({color: 0x00ffea, wireframe: true});
                const cube = new THREE.Mesh(geo, mat);
                scene.add(cube);
                
                function animate() { requestAnimationFrame(animate); cube.rotation.x += 0.01; cube.rotation.y += 0.01; renderer.render(scene, camera); }
                animate();
                log("Three.js OK. Cube should be spinning.");

                // 2. 初始化 AI
                log("Loading AI Models... (Check ./wasm path)");
                
                // 关键点：检查文件是否存在
                // 尝试 fetch 一下看能不能拿到
                try {
                    const check = await fetch('./wasm/vision_wasm_internal.wasm');
                    if(!check.ok) throw new Error(`WASM file checking failed: ${check.status}`);
                    log("WASM file found via Fetch.");
                } catch(e) {
                    throw new Error("Cannot find ./wasm/ files! " + e.message);
                }

                const vision = await FilesetResolver.forVisionTasks("./wasm");
                log("FilesetResolver OK.");

                const handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: { modelAssetPath: "./wasm/hand_landmarker.task", delegate: "GPU" },
                    runningMode: "VIDEO", numHands: 1
                });
                log("HandLandmarker Loaded! AI System Ready.");

                // 3. 启动摄像头
                log("Requesting Camera...");
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error("Browser API not supported or Non-HTTPS!");
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                const video = document.getElementById('webcam');
                video.srcObject = stream;
                video.addEventListener("loadeddata", () => {
                    log("Camera Stream Active!");
                });

            } catch (error) {
                log(error.message || error, 'error');
                log("STACK: " + error.stack, 'error');
            }
        }

        init();
    </script>
</body>
</html>
