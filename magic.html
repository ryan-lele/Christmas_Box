<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Gift V9.1 (Fix)</title>
    <style>
        /* --- Âü∫Á°ÄÈ£éÊ†º (‰øùÊåÅÈ°πÁõÆ‰∏ÄËá¥ÊÄß) --- */
        @font-face { font-family: 'TechMono'; src: local('Courier New'), monospace; }
        body { margin: 0; background: #000; overflow: hidden; font-family: 'TechMono'; color: #00ffea; }
        #hologram-canvas { position: absolute; inset: 0; z-index: 1; }
        
        /* Âº∫Âà∂ËßÜÈ¢ëËß£Á†Å (iOSÂøÖÈ°ª) */
        #webcam { position: fixed; top: -2000px; left: -2000px; width: 320px; height: 240px; opacity: 0.01; pointer-events: none; }

        /* --- Ë∞ÉËØïÊó•ÂøóÈù¢Êùø (ÂÖ≥ÈîÆÔºÅ) --- */
        #debug-log {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-height: 300px; overflow-y: auto;
            background: rgba(0, 0, 0, 0.9); border: 1px solid #ff0000;
            color: #00ff00; font-family: monospace; font-size: 12px;
            padding: 10px; z-index: 9999; display: block;
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px dashed #333; }
        .log-err { color: #ff3333; font-weight: bold; }

        /* UI */
        .hud-layer { position: absolute; width: 100%; pointer-events: none; padding: 15px; box-sizing: border-box; }
        .hud-top { top: 0; display: flex; justify-content: space-between; z-index: 20; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        .back-btn { pointer-events: auto; color: #00ffea; border: 1px solid #00ffea; padding: 5px 12px; text-decoration: none; font-size: 12px; background: rgba(0,0,0,0.5); }
        
        #gesture-status { 
            position: absolute; bottom: 80px; left: 0; width: 100%; text-align: center; 
            font-size: 12px; color: #fff; text-shadow: 0 0 5px cyan; opacity: 0.8; z-index: 10;
        }
        
        .left-dock { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 10px; pointer-events: auto; z-index: 30; }
        .deco-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid rgba(0,255,234,0.3); background: rgba(0,0,0,0.5); color: #00ffea; font-size: 18px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        
        .bottom-dock { position: absolute; bottom: 20px; width: 100%; text-align: center; pointer-events: auto; z-index: 30; }
        .upload-btn { border: 1px solid #00ffea; padding: 10px 30px; color: #00ffea; background: rgba(0,50,50,0.5); font-size: 12px; border-radius: 20px; display: inline-block;}
        #file-input { display: none; }
        
        #webcam-preview { position: absolute; top: 50px; right: 10px; width: 80px; height: 60px; border: 1px solid #333; opacity: 0.8; z-index: 5; transform: scaleX(-1); }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "@mediapipe/tasks-vision": "https://unpkg.com/@mediapipe/tasks-vision@0.10.8/wasm/vision_bundle.js"
        }
    }
    </script>
</head>
<body>

    <div id="debug-log">
        <div class="log-line">=== SYSTEM START V9.1 ===</div>
    </div>

    <div class="hud-layer hud-top">
        <div style="font-size:12px;">‚óè V9.1 FIX</div>
        <a href="mission.html" class="back-btn">EXIT</a>
    </div>

    <canvas id="hologram-canvas"></canvas>
    
    <div class="left-dock">
        <div class="deco-btn" onclick="addDeco('STAR')">‚òÖ</div>
        <div class="deco-btn" onclick="addDeco('GIFT')">üéÅ</div>
        <div class="deco-btn" onclick="addDeco('SOCK')">üß¶</div>
    </div>

    <div id="gesture-status">SYSTEM INITIALIZING...</div>
    <canvas id="webcam-preview"></canvas>
    <video id="webcam" autoplay playsinline muted></video>

    <div class="bottom-dock">
        <label class="upload-btn">üì∑ UPLOAD PHOTO<input type="file" id="file-input" multiple accept="image/*"></label>
    </div>

    <script>
        // --- Â±èÂπïÊó•ÂøóÂ∑•ÂÖ∑ ---
        function log(msg, isError = false) {
            const box = document.getElementById('debug-log');
            if (!box) return;
            const line = document.createElement('div');
            line.className = isError ? 'log-line log-err' : 'log-line';
            const time = new Date().toLocaleTimeString();
            line.innerText = `[${time}] ${msg}`;
            box.appendChild(line);
            box.scrollTop = box.scrollHeight; 
            console.log(msg);
        }
        window.onerror = function(msg) { log("GLOBAL ERROR: " + msg, true); };
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        let handLandmarker = undefined;
        let video = document.getElementById('webcam');

        // --- 1. ÂêØÂä®È°∫Â∫è ---
        async function init() {
            try {
                log("1. Init Three.js Scene...");
                initThree(); 
                
                log("2. Loading AI Engine (WASM) from unpkg...");
                
                // ÂÖ≥ÈîÆÁÇπÔºöÊòéÁ°ÆÊåáÂÆö WASM Êñá‰ª∂ÁöÑÂä†ËΩΩË∑ØÂæÑ
                const vision = await FilesetResolver.forVisionTasks(
                    "https://unpkg.com/@mediapipe/tasks-vision@0.10.8/wasm"
                );
                log(">> WASM Engine Loaded OK.");

                log("3. Loading Model File (Local)...");
                log(">> Path: ./wasm/hand_landmarker.task");
                
                // Âä†ËΩΩÊú¨Âú∞Ê®°Âûã
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "./wasm/hand_landmarker.task", 
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numHands: 1
                });
                log(">> Model Loaded OK!");

                log("4. Requesting Camera...");
                await startCamera();
                log(">> Camera Started.");

                log("=== ALL SYSTEMS GO ===");
                // ÊàêÂäüÂêéÈöêËóèÊó•ÂøóÊ°Ü
                setTimeout(() => {
                    document.getElementById('debug-log').style.display = 'none';
                    document.getElementById('gesture-status').innerText = "HAND TRACKING ACTIVE";
                    startLoop();
                }, 1000);

            } catch (e) {
                log("FATAL ERROR: " + e.message, true);
                document.getElementById('gesture-status').innerText = "SYSTEM ERROR";
            }
        }

        // --- 2. ÊëÑÂÉèÂ§¥ ---
        async function startCamera() {
            if (!navigator.mediaDevices?.getUserMedia) {
                throw new Error("No Camera API (check HTTPS)");
            }
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "user", width: {ideal: 320}, height: {ideal: 240} }
            });
            video.srcObject = stream;
            return new Promise(r => {
                video.onloadedmetadata = () => { video.play(); r(); };
            });
        }

        // --- 3. Ê∏≤ÊüìÂæ™ÁéØ ---
        const webcamCtx = document.getElementById('webcam-preview').getContext('2d');
        document.getElementById('webcam-preview').width = 160;
        document.getElementById('webcam-preview').height = 120;

        function startLoop() {
            function render() {
                // AI È¢ÑÊµã
                if (video.readyState >= 2 && handLandmarker) {
                    let results;
                    try { 
                        results = handLandmarker.detectForVideo(video, performance.now()); 
                    } catch(e) { console.error(e); }

                    webcamCtx.drawImage(video, 0, 0, 160, 120);

                    if(results && results.landmarks.length > 0) {
                        const lm = results.landmarks[0];
                        webcamCtx.fillStyle = '#00ffea'; 
                        for(let p of lm) { 
                            webcamCtx.beginPath(); webcamCtx.arc(p.x*160, p.y*120, 2, 0, 2*Math.PI); webcamCtx.fill(); 
                        }
                        processGesture(lm);
                    }
                }
                
                composer.render();
                requestAnimationFrame(render);
            }
            render();
        }

        function processGesture(lm) {
            const wrist = lm[0]; 
            const tips = [lm[8], lm[12], lm[16], lm[20]];
            let spread = 0;
            tips.forEach(t => spread += Math.hypot(t.x-wrist.x, t.y-wrist.y));
            spread /= 4;

            if (spread > 0.3) {
                document.getElementById('gesture-status').innerText = "‚úã OPEN: SCATTER";
                particles.forEach(p => p.position.lerp(p.userData.scatterPos, 0.08));
            } else {
                document.getElementById('gesture-status').innerText = "‚úä FIST: SPIN";
                particles.forEach(p => p.position.lerp(p.userData.basePos, 0.1));
                group.rotation.y += 0.1;
            }
        }

        let scene, camera, renderer, composer, group;
        const particles = [];
        
        function initThree() {
            scene = new THREE.Scene(); 
            camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 6, 45);
            renderer = new THREE.WebGLRenderer({canvas: document.getElementById('hologram-canvas'), alpha:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            const rp = new RenderPass(scene, camera);
            const bp = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.6, 0.85);
            composer = new EffectComposer(renderer); composer.addPass(rp); composer.addPass(bp);

            group = new THREE.Group(); scene.add(group);
            
            const geo = new THREE.TetrahedronGeometry(0.5);
            const mat = new THREE.MeshBasicMaterial({color: 0x00ffea, transparent:true, opacity:0.8});
            
            for(let i=0; i<900; i++) {
                const mesh = new THREE.Mesh(geo, mat);
                const t = Math.random(); const y = t*30 - 15; const r = (1-t)*10; const a = Math.random()*6.28;
                mesh.position.set(Math.cos(a)*r, y, Math.sin(a)*r);
                mesh.userData = { 
                    basePos: mesh.position.clone(),
                    scatterPos: new THREE.Vector3((Math.random()-0.5)*60, (Math.random()-0.5)*60, (Math.random()-0.5)*60),
                };
                group.add(mesh); particles.push(mesh);
            }
            
            const light = new THREE.PointLight(0x00ffff, 1, 100); light.position.set(10, 10, 10); scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        }

        window.addDeco = (type) => {
            const colors = {STAR:0xffff00, GIFT:0xff0000, SOCK:0x00ff00, APPLE:0xff0000, BAUBLE:0x0000ff};
            const m = new THREE.Mesh(new THREE.SphereGeometry(1), new THREE.MeshBasicMaterial({color: colors[type] || 0xffffff}));
            m.position.set((Math.random()-0.5)*15, Math.random()*20-5, 8);
            group.add(m);
        }

        const fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const tex = new THREE.TextureLoader().load(ev.target.result);
                    const photo = new THREE.Mesh(new THREE.PlaneGeometry(5,5*0.75), new THREE.MeshBasicMaterial({map:tex, side:THREE.DoubleSide}));
                    photo.position.z = 10;
                    group.add(photo);
                    alert("Photo Added!");
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        init();
    </script>
</body>
</html>
