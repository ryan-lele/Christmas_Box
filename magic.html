<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Gift V10.0 (Sensor)</title>
    
    <style>
        /* --- è§†è§‰é£æ ¼ï¼šä¿æŒ V9 çš„èµ›åšæœ‹å…‹æ„Ÿ --- */
        @font-face { font-family: 'TechMono'; src: local('Courier New'), monospace; }
        body { margin: 0; background: #000; overflow: hidden; font-family: 'TechMono', monospace; color: #00ffea; touch-action: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤ç¼©æ”¾ */ }
        
        #hologram-canvas { position: absolute; inset: 0; z-index: 1; }

        /* --- å¯åŠ¨é®ç½© (iOSå¿…é¡») --- */
        #start-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(10px); transition: opacity 0.5s;
        }
        .start-btn {
            padding: 15px 40px; font-size: 18px; color: #000; 
            background: #00ffea; border: none; border-radius: 2px;
            font-family: 'TechMono', monospace; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 20px #00ffea; letter-spacing: 2px;
            animation: pulse 1.5s infinite;
        }
        .start-hint { margin-top: 20px; color: #666; font-size: 12px; max-width: 80%; text-align: center; }
        @keyframes pulse { 0%{box-shadow:0 0 10px #00ffea;} 50%{box-shadow:0 0 30px #00ffea;} 100%{box-shadow:0 0 10px #00ffea;} }

        /* HUD UI */
        .hud-layer { position: absolute; width: 100%; pointer-events: none; padding: 15px; box-sizing: border-box; }
        .hud-top { top: 0; display: flex; justify-content: space-between; z-index: 20; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        .back-btn { pointer-events: auto; color: #00ffea; border: 1px solid #00ffea; padding: 5px 12px; text-decoration: none; font-size: 12px; background: rgba(0,0,0,0.5); }
        
        #gesture-status { 
            position: absolute; bottom: 80px; left: 0; width: 100%; text-align: center; 
            font-size: 12px; color: #fff; text-shadow: 0 0 5px cyan; opacity: 0.9; z-index: 10;
            pointer-events: none;
        }
        
        .left-dock { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; pointer-events: auto; z-index: 30; }
        .deco-btn { width: 45px; height: 45px; border-radius: 50%; border: 1px solid rgba(0,255,234,0.3); background: rgba(0,0,0,0.5); color: #00ffea; font-size: 20px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .deco-btn:active { transform: scale(0.9); background: rgba(0,255,234,0.2); }
        
        .bottom-dock { position: absolute; bottom: 30px; width: 100%; text-align: center; pointer-events: auto; z-index: 30; }
        .upload-btn { border: 1px solid #00ffea; padding: 12px 30px; color: #00ffea; background: rgba(0,50,50,0.8); font-size: 12px; border-radius: 30px; display: inline-block; backdrop-filter: blur(4px);}
        #file-input { display: none; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>

    <div id="start-screen">
        <h1 style="color:#00ffea; font-size:24px; margin-bottom:30px; letter-spacing:4px;">HOLOGRAM V10</h1>
        <button class="start-btn" id="btn-start">INITIALIZE SYSTEM</button>
        <div class="start-hint">Tap to enable Gyroscope & Neural Link</div>
    </div>

    <div class="hud-layer hud-top">
        <div style="font-size:12px;">â— SENSOR MODE</div>
        <a href="mission.html" class="back-btn">EXIT</a>
    </div>

    <canvas id="hologram-canvas"></canvas>
    
    <div class="left-dock">
        <div class="deco-btn" onclick="addDeco('STAR')">â˜…</div>
        <div class="deco-btn" onclick="addDeco('GIFT')">ğŸ</div>
        <div class="deco-btn" onclick="addDeco('SOCK')">ğŸ§¦</div>
        <div class="deco-btn" onclick="addDeco('APPLE')">ğŸ</div>
    </div>

    <div id="gesture-status">WAITING FOR INPUT...</div>

    <div class="bottom-dock">
        <label class="upload-btn">ğŸ“· UPLOAD MEMORY<input type="file" id="file-input" multiple accept="image/*"></label>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- æ ¸å¿ƒé…ç½® ---
        const CONFIG = {
            colors: { bg: 0x000000, blueMain: 0x00ffea, whiteSilver: 0xffffff },
            tree: { height: 26, radius: 9, count: 1200 }
        };

        const STATE = { 
            mode: 'TREE', // TREE, SCATTER
            targetGroupPos: new THREE.Vector3(0,0,0),
            gyro: { x: 0, y: 0 },
            autoRotate: true
        };

        let scene, camera, renderer, composer, group, particles = [], photoMeshes = [];
        let snowSystem;
        let clock = new THREE.Clock();

        // --- 1. åˆå§‹åŒ–å…¥å£ ---
        function init() {
            initThree();
            createParticles();
            createSnow();
            setupEvents();
            animate();
        }

        // --- 2. 3D åœºæ™¯æ„å»º ---
        function initThree() {
            const canvas = document.getElementById('hologram-canvas');
            scene = new THREE.Scene(); 
            // é›¾æ•ˆå¢å¼ºæ™¯æ·±
            scene.fog = new THREE.FogExp2(0x000000, 0.02);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 45);

            renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            // åå¤„ç†ï¼šè¾‰å…‰
            const rp = new RenderPass(scene, camera);
            const bp = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.6, 0.85);
            composer = new EffectComposer(renderer); composer.addPass(rp); composer.addPass(bp);

            group = new THREE.Group(); scene.add(group);

            // ç¯å…‰
            const light = new THREE.PointLight(0x00ffff, 1, 100); light.position.set(10, 20, 20); scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        }

        // --- 3. ç²’å­æ ‘ ---
        function createParticles() {
            const geo = new THREE.TetrahedronGeometry(0.4);
            const mat = new THREE.MeshBasicMaterial({color: 0x00ffea, transparent:true, opacity:0.8});
            
            for(let i=0; i<CONFIG.tree.count; i++) {
                const mesh = new THREE.Mesh(geo, mat);
                // æ ‘å½¢åˆ†å¸ƒ
                const t = Math.random(); 
                const h = CONFIG.tree.height; 
                const r = CONFIG.tree.radius * (1-t); 
                const y = t * h - h/2 + 2; 
                const a = Math.random() * Math.PI * 2;
                
                mesh.position.set(Math.cos(a)*r, y, Math.sin(a)*r);
                mesh.rotation.set(Math.random()*6, Math.random()*6, Math.random()*6);
                
                // å­˜å‚¨çŠ¶æ€
                mesh.userData = { 
                    basePos: mesh.position.clone(),
                    // ç‚¸å¼€åçš„ä½ç½® (çƒå½¢åˆ†å¸ƒ)
                    scatterPos: new THREE.Vector3((Math.random()-0.5)*50, (Math.random()-0.5)*50, (Math.random()-0.5)*50),
                    speed: Math.random() * 2 + 1
                };
                group.add(mesh); particles.push(mesh);
            }
        }

        function createSnow() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<3000; i++) pos.push((Math.random()-0.5)*100, (Math.random()-0.5)*100, (Math.random()-0.5)*100);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            snowSystem = new THREE.Points(geo, new THREE.PointsMaterial({color:0xffffff, size:0.5, transparent:true, opacity:0.5}));
            scene.add(snowSystem);
        }

        // --- 4. äº¤äº’æ ¸å¿ƒ (ä¼ æ„Ÿå™¨ + è§¦æ‘¸) ---
        function setupEvents() {
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth,window.innerHeight); composer.setSize(window.innerWidth,window.innerHeight);
            });

            // å¯åŠ¨æŒ‰é’® (iOS æƒé™å…¥å£)
            document.getElementById('btn-start').onclick = () => {
                const screen = document.getElementById('start-screen');
                screen.style.opacity = 0;
                setTimeout(()=>screen.remove(), 500);
                
                // è¯·æ±‚é™€èºä»ªæƒé™
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission().then(resp => {
                        if (resp === 'granted') window.addEventListener('deviceorientation', handleGyro);
                    }).catch(console.error);
                } else {
                    window.addEventListener('deviceorientation', handleGyro);
                }
                
                // æ‘‡ä¸€æ‘‡ç›‘å¬
                window.addEventListener('devicemotion', handleShake);
                
                document.getElementById('gesture-status').innerText = "PINCH TO SCATTER | SHAKE FOR SNOW";
            };

            // è§¦æ‘¸æ‰‹åŠ¿ (åŒæŒ‡ç¼©æ”¾)
            let startDist = 0;
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    startDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                }
            }, {passive: false});

            document.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault(); // ç¦æ­¢é¡µé¢æ»šåŠ¨
                    const currDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                    
                    if (currDist > startDist + 30) {
                        STATE.mode = 'SCATTER'; // æ”¾å¤§ -> æ•£å¼€
                        STATE.autoRotate = false;
                        document.getElementById('gesture-status').innerText = "âœ¨ MAGIC SCATTER âœ¨";
                    } else if (currDist < startDist - 30) {
                        STATE.mode = 'TREE'; // ç¼©å° -> è¿˜åŸ
                        STATE.autoRotate = true;
                        document.getElementById('gesture-status').innerText = "ğŸ„ ASSEMBLING ğŸ„";
                    }
                } else if (e.touches.length === 1 && STATE.mode === 'SCATTER') {
                    // å•æŒ‡æ—‹è½¬
                    const touch = e.touches[0];
                    group.rotation.y += touch.clientX * 0.0001;
                    group.rotation.x += touch.clientY * 0.0001;
                }
            }, {passive: false});
        }

        // é™€èºä»ªå¤„ç†
        function handleGyro(e) {
            // Gamma: å·¦å³å€¾æ–œ, Beta: å‰åå€¾æ–œ
            // å¹³æ»‘å¤„ç†
            STATE.gyro.x = (e.gamma || 0) * 0.02; 
            STATE.gyro.y = ((e.beta || 0) - 45) * 0.02; // å‡45åº¦æ˜¯å› ä¸ºç”¨æˆ·é€šå¸¸å€¾æ–œæ‹¿ç€æ‰‹æœº
        }

        // æ‘‡ä¸€æ‘‡å¤„ç†
        let lastShake = 0;
        function handleShake(e) {
            const acc = e.accelerationIncludingGravity;
            if(!acc) return;
            
            // ç®€å•ç®—æ³•ï¼šæ£€æµ‹åŠ é€Ÿåº¦çªå˜
            const strength = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
            if (strength > 25 && Date.now() - lastShake > 1000) {
                lastShake = Date.now();
                triggerSnowStorm();
            }
        }

        function triggerSnowStorm() {
            // æš´é£é›ªç‰¹æ•ˆ
            const pos = snowSystem.geometry.attributes.position.array;
            for(let i=0; i<pos.length; i++) pos[i] += (Math.random()-0.5) * 50;
            snowSystem.geometry.attributes.position.needsUpdate = true;
            
            document.getElementById('gesture-status').innerText = "â„ï¸ BLIZZARD DETECTED â„ï¸";
            // éœ‡åŠ¨åé¦ˆ (å®‰å“æ”¯æŒè¾ƒå¥½)
            if(navigator.vibrate) navigator.vibrate(200);
            
            setTimeout(() => {
                document.getElementById('gesture-status').innerText = "PINCH TO CONTROL";
            }, 2000);
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();
            const time = clock.elapsedTime;

            // 1. æ ‘çš„å½¢æ€æ§åˆ¶
            let target = STATE.mode === 'SCATTER' ? 'scatterPos' : 'basePos';
            particles.forEach(p => {
                p.position.lerp(p.userData[target], 0.1);
            });

            // 2. æ—‹è½¬æ§åˆ¶ (è‡ªåŠ¨ + é™€èºä»ª)
            if (STATE.autoRotate) {
                group.rotation.y += 0.005;
            }
            // é™€èºä»ªå¸¦æ¥çš„è§†å·® (è®©æ ‘çœ‹èµ·æ¥æ˜¯æ‚¬æµ®çš„)
            group.rotation.x = THREE.MathUtils.lerp(group.rotation.x, STATE.gyro.y, 0.1);
            group.rotation.z = THREE.MathUtils.lerp(group.rotation.z, STATE.gyro.x, 0.1);

            // 3. é›ªèŠ±é£˜è½
            if (snowSystem) {
                const pos = snowSystem.geometry.attributes.position.array;
                for(let i=1; i<pos.length; i+=3) {
                    pos[i] -= 0.2; // ä¸‹è½
                    if(pos[i] < -50) pos[i] = 50; // å¾ªç¯
                }
                snowSystem.geometry.attributes.position.needsUpdate = true;
            }

            composer.render();
        }

        // è£…é¥°åŠŸèƒ½ (æš´éœ²ç»™å…¨å±€)
        window.addDeco = (type) => {
            const colors = {STAR:0xffff00, GIFT:0xff0000, SOCK:0x00ff00, APPLE:0xff0000};
            const geo = new THREE.SphereGeometry(1);
            const mat = new THREE.MeshBasicMaterial({color: colors[type]||0xffffff});
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set((Math.random()-0.5)*20, Math.random()*20-5, 5);
            // è£…é¥°å“ä¹Ÿä¼šè·Ÿéšæ•£å¼€
            mesh.userData = {
                basePos: mesh.position.clone(),
                scatterPos: new THREE.Vector3((Math.random()-0.5)*50, (Math.random()-0.5)*50, (Math.random()-0.5)*50)
            };
            group.add(mesh);
            particles.push(mesh);
        }

        // å›¾ç‰‡ä¸Šä¼ 
        document.getElementById('file-input').addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    new THREE.TextureLoader().load(ev.target.result, (tex) => {
                        const mesh = new THREE.Mesh(new THREE.PlaneGeometry(8,8), new THREE.MeshBasicMaterial({map:tex, side:THREE.DoubleSide}));
                        mesh.position.z = 10;
                        // å›¾ç‰‡é€»è¾‘ï¼šå§‹ç»ˆæ˜¾ç¤ºï¼Œä½†åœ¨æ•£å¼€æ—¶ä¼šé£˜åŠ¨
                        mesh.userData = { basePos: mesh.position.clone(), scatterPos: mesh.position.clone() };
                        group.add(mesh);
                        particles.push(mesh);
                        alert("Photo Added!");
                    });
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        init();
    </script>
</body>
</html>
